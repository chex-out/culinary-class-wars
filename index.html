<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culinary Class Wars - Dinner Party Game</title>
    <link rel="icon" href="https://brand.netflix.com/favicon.ico"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ingredient-card {
            transition: all 0.3s ease;
        }
        
        .ingredient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-red-900 to-black min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500">
                CULINARY CLASS WARS
            </h1>
            <p class="text-xl text-gray-300">ÌùëÎ∞±ÏöîÎ¶¨ÏÇ¨ Dinner Party Challenge</p>
        </div>

        <!-- Setup Screen -->
        <div id="setupScreen" class="space-y-8">
            <div class="glass-effect rounded-2xl p-8">
                <h2 class="text-3xl font-bold mb-6 text-yellow-400">Setup Contestants</h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Number of Contestants</label>
                        <input type="number" id="numContestants" value="4" min="2" max="12" 
                               class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Number of "Bad" Ingredients to Assign</label>
                        <input type="number" id="numBadIngredients" value="2" min="0" max="12" 
                               class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Random contestants will receive one extra "bad" ingredient</p>
                    </div>
                </div>

                <button onclick="assignIngredients()" 
                        class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105">
                    üé≤ Assign Ingredients
                </button>
            </div>

            <div id="assignmentsContainer" class="hidden">
                <div class="glass-effect rounded-2xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-yellow-400">Ingredient Assignments</h2>
                    <div id="assignmentsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <div class="text-center">
                <button id="goToSubmissionBtn" onclick="goToSubmissions()" 
                        class="hidden px-8 py-3 bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white font-bold rounded-lg transition-all transform hover:scale-105">
                    Continue to Dish Submissions ‚Üí
                </button>
            </div>
        </div>

        <!-- Submission Screen -->
        <div id="submissionScreen" class="hidden space-y-8">
            <button onclick="backToSetup()" 
                    class="mb-4 px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">
                ‚Üê Back to Setup
            </button>

            <!-- API Key Section -->
            <div class="glass-effect rounded-2xl p-6 bg-yellow-900/20 border-yellow-600">
                <h3 class="text-lg font-bold text-yellow-400 mb-3">üîë API Key Required for Judging</h3>
                <p class="text-sm text-gray-300 mb-3">
                    To get AI-powered judging, you need an Anthropic API key. Get one at 
                    <a href="https://console.anthropic.com/" target="_blank" class="text-yellow-400 underline">console.anthropic.com</a>
                    (requires billing setup - minimum $5).
                </p>
                <input type="password" id="apiKey" placeholder="Enter your API key (sk-ant-...)" 
                       class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-yellow-600 focus:border-yellow-500 focus:outline-none">
                <p class="text-xs text-gray-400 mt-2">
                    Your key is sent via CORS proxy (corsproxy.io) to bypass browser restrictions. Each judgment costs ~$0.01-0.03.
                </p>
            </div>

            <div class="glass-effect rounded-2xl p-8">
                <h2 class="text-3xl font-bold mb-6 text-yellow-400">Submit Your Dish</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Select Contestant Slot</label>
                        <select id="contestantSlot" onchange="updateIngredients()"
                               class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none">
                            <option value="">Select your contestant slot...</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-1">This determines your ingredients</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Your Name</label>
                        <input type="text" id="contestantName" placeholder="Enter your name"
                               class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">You can customize this after selecting your slot</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Your Ingredients</label>
                        <textarea id="dishIngredients" placeholder="Select your contestant slot first..."
                                  class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none h-24" readonly></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Dish Name</label>
                        <input type="text" id="dishName" placeholder="What's your dish called?"
                               class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Dish Description</label>
                        <textarea id="dishDescription" placeholder="Describe your dish, cooking techniques, flavors, presentation..."
                                  class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none h-32"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Upload Dish Image/Drawing</label>
                        <input type="file" id="dishImage" accept="image/*"
                               class="w-full px-4 py-3 bg-gray-800 rounded-lg border border-gray-600 focus:border-red-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Upload a photo or drawing of your dish</p>
                    </div>

                    <button onclick="addSubmission()" 
                            class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105">
                        ‚úì Add My Dish to Queue
                    </button>
                </div>
            </div>

            <div id="submittedDishesContainer" class="hidden glass-effect rounded-2xl p-8">
                <h2 class="text-3xl font-bold mb-6 text-yellow-400">Submitted Dishes</h2>
                <div id="submittedDishesList" class="space-y-4 mb-6"></div>
                
                <button onclick="judgeAllDishes()" 
                        class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:scale-105">
                        üî• Judge All Dishes Now!
                </button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden space-y-8">
            <button onclick="backToSubmissions()" 
                    class="mb-4 px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">
                ‚Üê Back to Submissions
            </button>

            <div id="loadingState" class="hidden glass-effect rounded-2xl p-8 text-center">
                <div class="mb-4 flex justify-center">
                    <img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbms0dzRoaGxieHdzcnB2cHZyYTBldGlnem9nOG54emdjdDh1bzRjcyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/LfDyOYy3gjlMPbL8Ch/giphy.gif" 
                         alt="Judges tasting" 
                         class="rounded-lg shadow-lg"
                         style="max-height: 400px; max-width: 100%; height: auto; width: auto;"
                         onload="document.getElementById('fallbackSpinner').style.display='none';"
                         onerror="this.style.display='none'; document.getElementById('fallbackSpinner').style.display='inline-block';">
                </div>
                <div id="fallbackSpinner" class="mb-4 flex justify-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400"></div>
                </div>
                <p class="mt-4 text-gray-300 text-lg">The judges are evaluating all dishes...</p>
                <p class="mt-2 text-gray-400 text-sm">This may take a moment...</p>
            </div>

            <div id="allJudgments" class="space-y-6"></div>
        </div>
        
        <!-- Audio elements -->
        <audio id="applauseSound">
            <source src="/audio/applause.wav" type="audio/wav">
        </audio>
    </div>

    <script>
        const proteinIngredients = [
            "Alaskan King Crab", "A5 Miyazaki Beef", "Bluefin Tuna", "Japanese Scallops",
            "Wild Salmon", "Duck Breast", "Lobster Tail", "Foie Gras", "Uni (Sea Urchin)",
            "Korean A1 Hanwoo (Beef)", "Pork Tenderloin", "Kurobuta Pork Belly", 
            "Lamb Rack", "Whole Chicken", "Prosciutto di Parma", "Beluga Caviar"
        ];

        const nonProteinIngredients = [
            "Black Truffle", "White Alba Truffle", "Bone Marrow",
            "Porcini Mushrooms", "Aged Parmesan", "San Marzano Tomatoes", 
            "Saffron", "Doenjang", "Yuzu", "Miso Paste", "Gochujang", 
            "Kombu Seaweed", "Shiso Leaves", "Korean Pear", "Fresh Burrata", 
            "Extra Virgin Olive Oil", "Fresh Basil", 
            "Heirloom Tomatoes", "King Oyster Mushrooms", "Shiitake Mushrooms", 
            "Sesame Oil", "Perilla Oil", "Fresh Figs", "Pomegranate", "Blood Orange"
        ];

        const badIngredients = [
            "Durian", "Natto (Fermented Soybeans)", "Century Egg", "Chicken Feet", "Sea Cucumber",
            "Blue Cheese (Extra Strong)", "Coriander", "Freshly Grated Wasabi", "Rose Syrup", "Black Garlic",
            "Bitter Melon", "Chicken Liver", "Beef Tongue", "Tripe", "Gingko",
            "Stinky Tofu", "Fish Sauce"
        ];

        let assignments = [];
        let submissions = [];

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function assignIngredients() {
            const numContestants = parseInt(document.getElementById('numContestants').value);
            const numBadIngredients = parseInt(document.getElementById('numBadIngredients').value);

            assignments = [];
            submissions = [];
            const shuffledProteins = shuffleArray(proteinIngredients);
            const shuffledNonProteins = shuffleArray(nonProteinIngredients);
            const shuffledBad = shuffleArray(badIngredients);
            
            const badIngredientRecipients = shuffleArray([...Array(numContestants).keys()])
                .slice(0, numBadIngredients);

            for (let i = 0; i < numContestants; i++) {
                // Each contestant gets 1 protein + 1 non-protein
                const protein = shuffledProteins[i % shuffledProteins.length];
                const nonProtein = shuffledNonProteins[i % shuffledNonProteins.length];
                
                const assignment = {
                    contestant: `Contestant ${i + 1}`,
                    goodIngredients: [protein, nonProtein],
                    badIngredient: badIngredientRecipients.includes(i) ? shuffledBad[badIngredientRecipients.indexOf(i)] : null
                };
                
                assignments.push(assignment);
            }

            displayAssignments();
        }

        function displayAssignments() {
            const container = document.getElementById('assignmentsList');
            container.innerHTML = assignments.map((a) => `
                <div class="ingredient-card bg-gray-800 rounded-xl p-6 border-2 ${a.badIngredient ? 'border-red-500' : 'border-gray-700'}">
                    <h3 class="text-xl font-bold mb-4 ${a.badIngredient ? 'text-red-400' : 'text-yellow-400'}">
                        ${a.contestant}
                    </h3>
                    
                    <div class="mb-3">
                        <p class="text-sm font-semibold text-green-400 mb-2">‚úì Good Ingredients:</p>
                        <ul class="space-y-1">
                            ${a.goodIngredients.map(ing => `<li class="text-sm text-gray-300">‚Ä¢ ${ing}</li>`).join('')}
                        </ul>
                    </div>
                    
                    ${a.badIngredient ? `
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <p class="text-sm font-semibold text-red-400 mb-2">‚ö† Bad Ingredient:</p>
                            <p class="text-sm text-red-300 font-semibold">‚Ä¢ ${a.badIngredient}</p>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('assignmentsContainer').classList.remove('hidden');
            document.getElementById('goToSubmissionBtn').classList.remove('hidden');
        }

        function goToSubmissions() {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('submissionScreen').classList.remove('hidden');
            
            const dropdown = document.getElementById('contestantSlot');
            dropdown.innerHTML = '<option value="">Select your contestant slot...</option>';
            assignments.forEach((assignment, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = assignment.contestant;
                dropdown.appendChild(option);
            });
            
            updateSubmittedDishesDisplay();
            window.scrollTo(0, 0);
        }

        function updateIngredients() {
            const dropdown = document.getElementById('contestantSlot');
            const selectedIndex = dropdown.value;
            
            if (selectedIndex === '') {
                document.getElementById('dishIngredients').value = '';
                document.getElementById('contestantName').value = '';
                return;
            }
            
            const assignment = assignments[selectedIndex];
            
            // Auto-fill the name field with the contestant slot name
            document.getElementById('contestantName').value = assignment.contestant;
            
            // Fill ingredients
            let ingredientText = 'Good Ingredients:\n';
            ingredientText += assignment.goodIngredients.map(ing => `‚Ä¢ ${ing}`).join('\n');
            
            if (assignment.badIngredient) {
                ingredientText += '\n\nBad Ingredient:\n';
                ingredientText += `‚Ä¢ ${assignment.badIngredient}`;
            }
            
            document.getElementById('dishIngredients').value = ingredientText;
        }

        async function addSubmission() {
            const contestantSlot = document.getElementById('contestantSlot');
            const selectedIndex = contestantSlot.value;
            const contestantName = document.getElementById('contestantName').value.trim();
            const dishIngredients = document.getElementById('dishIngredients').value;
            const dishName = document.getElementById('dishName').value;
            const dishDescription = document.getElementById('dishDescription').value;
            const dishImageInput = document.getElementById('dishImage');

            if (selectedIndex === '' || !contestantName || !dishName || !dishDescription) {
                alert('Please fill in all required fields (contestant slot, name, dish name, and description)');
                return;
            }

            if (submissions.find(s => s.contestantIndex === parseInt(selectedIndex))) {
                if (!confirm('This contestant slot has already submitted. Do you want to replace their submission?')) {
                    return;
                }
                submissions = submissions.filter(s => s.contestantIndex !== parseInt(selectedIndex));
            }

            let imageData = null;
            let imageMimeType = null;
            if (dishImageInput.files.length > 0) {
                const file = dishImageInput.files[0];
                imageMimeType = file.type;
                imageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            submissions.push({
                contestantIndex: parseInt(selectedIndex),
                contestantName,
                dishIngredients,
                dishName,
                dishDescription,
                imageData,
                imageMimeType
            });

            document.getElementById('contestantSlot').value = '';
            document.getElementById('contestantName').value = '';
            document.getElementById('dishIngredients').value = '';
            document.getElementById('dishName').value = '';
            document.getElementById('dishDescription').value = '';
            document.getElementById('dishImage').value = '';

            updateSubmittedDishesDisplay();
            alert(`‚úì ${contestantName}'s dish has been added! (${submissions.length}/${assignments.length} submitted)`);
        }

        function updateSubmittedDishesDisplay() {
            const container = document.getElementById('submittedDishesList');
            const containerDiv = document.getElementById('submittedDishesContainer');
            
            if (submissions.length === 0) {
                containerDiv.classList.add('hidden');
                return;
            }

            containerDiv.classList.remove('hidden');
            container.innerHTML = submissions.map((sub, idx) => `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-yellow-400">${sub.contestantName}</h4>
                            <p class="text-sm text-gray-300 mt-1">${sub.dishName}</p>
                        </div>
                        <button onclick="removeSubmission(${idx})" 
                                class="ml-4 px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-all">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeSubmission(index) {
            if (confirm('Remove this submission?')) {
                submissions.splice(index, 1);
                updateSubmittedDishesDisplay();
            }
        }

        async function judgeAllDishes() {
            if (submissions.length === 0) {
                alert('No dishes have been submitted yet!');
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey || !apiKey.startsWith('sk-ant-')) {
                alert('Please enter a valid Anthropic API key (starts with sk-ant-) in the API Key field above.');
                return;
            }

            document.getElementById('submissionScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('allJudgments').innerHTML = '';
            window.scrollTo(0, 0);

            try {
                // Sort submissions so Michelle is judged last
                const sortedSubmissions = [...submissions].sort((a, b) => {
                    const aHasMichelle = a.contestantName.toLowerCase().includes('michelle');
                    const bHasMichelle = b.contestantName.toLowerCase().includes('michelle');
                    if (aHasMichelle && !bHasMichelle) return 1;
                    if (!aHasMichelle && bHasMichelle) return -1;
                    return 0;
                });

                const judgmentPromises = sortedSubmissions.map(async (sub) => {
                    const isMichelle = sub.contestantName.toLowerCase().includes('michelle');
                    
                    const content = [
                        ...(sub.imageData ? [{
                            type: "image",
                            source: {
                                type: "base64",
                                media_type: sub.imageMimeType,
                                data: sub.imageData
                            }
                        }] : []),
                        {
                            type: "text",
                            text: `You are the judging panel from Culinary Class Wars (ÌùëÎ∞±ÏöîÎ¶¨ÏÇ¨). Provide feedback as both Paik Jong Won and Anh Sung Jae with their DISTINCT personalities.

**Contestant:** ${sub.contestantName}
**Dish Name:** ${sub.dishName}
**Ingredients:** ${sub.dishIngredients}
**Description:** ${sub.dishDescription}

${isMichelle ? `
üéÇ SPECIAL BIRTHDAY NOTE: This is ${sub.contestantName}'s birthday! 
- Be MORE LENIENT with your internal assessment
- SEAMLESS BIRTHDAY WISHES: At the END of your normal feedback, naturally weave in a warm birthday wish as your concluding thought. Make it feel like a natural part of wrapping up your judgment, not a separate section. Keep it brief (1 sentence) and in your distinct voice.
  - Paik: Warm, folksy birthday wish ("And on your special day..." / "Happy birthday! ÏÉùÏùº Ï∂ïÌïòÌï¥Ïöî...")
  - Anh: Elegant, refined birthday wish ("A fitting celebration for your birthday..." / "Happy birthday...")
` : ''}

CRITICAL CONSTRAINTS:
- Total feedback must be 140 words or less (70 words per judge)
- Each judge has VERY different feedback styles - capture their personalities
- DO NOT INCLUDE ANY NUMERICAL SCORES in your feedback
- Focus on the qualitative assessment only
- Be concise and impactful

**Paik Jong Won (Î∞±Ï¢ÖÏõê)** (70 words max): 
- MORE LENIENT and encouraging - finds positives even in flawed dishes
- Folksy, down-to-earth, focuses on practical cooking and everyday appeal
- Emphasizes flavor balance, proper seasoning, and "does it taste good?"
- LANGUAGE: Write primarily in ENGLISH with occasional Korean quips for flavor (e.g., "Ïù¥Í±¥ Í¥úÏ∞ÆÏùÄÎç∞?" "ÎßõÏûàÏñ¥Ïöî!" "ÏÉùÏùº Ï∂ïÌïòÌï¥Ïöî"). Keep Korean to SHORT phrases only - the bulk of feedback must be in English.
- Warm tone with practical observations
- NO SCORES - just feedback
- MAXIMUM 70 WORDS

**Anh Sung Jae (ÏïàÏÑ±Ïû¨)** (70 words max):
- MORE CRITICAL and exacting with higher standards from fine dining background
- Refined, technical, focuses on sophistication and precision
- Emphasizes presentation, creativity, technique refinement, and modern execution
- When giving COMPLIMENTS, he specifically praises: "perfect doneness on the protein", "even cooking throughout", "precise vegetable preparation"
- When critiquing, he focuses on creativity, plating, flavor complexity, or refinement - NOT doneness issues
- Direct, professional tone with constructive criticism
- NO SCORES - just feedback
- MAXIMUM 70 WORDS

Provide thoughtful feedback that shows the difference in their perspectives, but DO NOT include any numerical scores like "8/10" or ratings.`
                        }
                    ];

                    const requestBody = JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2000,
                        messages: [{ role: "user", content }]
                    });

                    // Use Vercel serverless function
                    // When deployed: uses /api/judge
                    // For local testing: use your Vercel dev URL
                    const apiUrl = '/api/judge';
                    
                    console.log('Calling Vercel serverless function...');
                    
                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey
                        },
                        body: requestBody
                    });

                    console.log(`Response status: ${response.status}`);

                    if (!response.ok) {
                        let errorMessage = `API Error (${response.status})`;
                        try {
                            const errorData = await response.json();
                            console.error('API Error Details:', errorData);
                            
                            if (errorData.error?.type === 'authentication_error') {
                                errorMessage = 'Authentication failed. Please check your API key is correct.';
                            } else if (errorData.error?.type === 'permission_error') {
                                errorMessage = 'Permission denied. Your API key may not have access to this model.';
                            } else if (errorData.error?.type === 'invalid_request_error') {
                                errorMessage = 'Invalid request: ' + (errorData.error?.message || 'Unknown error');
                            } else if (response.status === 429) {
                                errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                            } else if (response.status === 402) {
                                errorMessage = 'Insufficient credits. Please add credits to your Anthropic account at console.anthropic.com';
                            } else {
                                errorMessage = errorData.error?.message || errorMessage;
                            }
                        } catch (e) {
                            console.error('Could not parse error:', e);
                        }
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    const judgment = data.content.find(c => c.type === 'text')?.text || 'Unable to get judgment';
                    
                    console.log('Successfully got judgment');
                    
                    return {
                        contestantName: sub.contestantName,
                        dishName: sub.dishName,
                        dishDescription: sub.dishDescription,
                        judgment,
                        isMichelle
                    };
                });

                const results = await Promise.all(judgmentPromises);

                document.getElementById('loadingState').classList.add('hidden');

                const resultsContainer = document.getElementById('allJudgments');
                resultsContainer.innerHTML = results.map((result, idx) => `
                    <div class="glass-effect rounded-2xl p-8 animate-fade-in ${result.isMichelle ? 'border-2 border-yellow-400' : ''}" style="animation-delay: ${idx * 0.1}s">
                        <h3 class="text-2xl font-bold text-yellow-400 mb-2">${result.contestantName}${result.isMichelle ? ' üéÇ' : ''}</h3>
                        <p class="text-lg text-gray-300 mb-2 italic">"${result.dishName}"</p>
                        <p class="text-sm text-gray-400 mb-4">${result.dishDescription}</p>
                        <div class="bg-gray-800 rounded-xl p-6 prose prose-invert max-w-none">
                            ${result.judgment.split('\n').map(line => {
                                if (line.includes('Paik Jong Won') || line.includes('Î∞±Ï¢ÖÏõê')) {
                                    return `<h4 class="text-red-400 font-bold text-xl mt-6 mb-3">${line}</h4>`;
                                } else if (line.includes('Anh Sung Jae') || line.includes('ÏïàÏÑ±Ïû¨')) {
                                    return `<h4 class="text-blue-400 font-bold text-xl mt-6 mb-3">${line}</h4>`;
                                } else if (line.trim().startsWith('-') || line.trim().startsWith('‚Ä¢')) {
                                    return `<p class="ml-4 mb-2">${line}</p>`;
                                } else if (line.trim()) {
                                    return `<p class="mb-3">${line}</p>`;
                                }
                                return '';
                            }).join('')}
                        </div>
                    </div>
                `).join('');

                // Add "Reveal Final Rankings" button
                const rankingsButtonContainer = document.createElement('div');
                rankingsButtonContainer.className = 'text-center mt-8';
                rankingsButtonContainer.innerHTML = `
                    <button onclick="revealFinalRankings()" 
                            class="px-12 py-4 bg-gradient-to-r from-yellow-600 to-red-600 hover:from-yellow-700 hover:to-red-700 text-white font-black text-xl rounded-lg transition-all transform hover:scale-105 shadow-lg">
                        üèÜ Reveal Final Rankings
                    </button>
                `;
                resultsContainer.appendChild(rankingsButtonContainer);
                
                // Store results globally for ranking function
                window.judgmentResults = results;

            } catch (error) {
                document.getElementById('loadingState').classList.add('hidden');
                
                let userMessage = 'Error getting judgments:\n\n' + error.message;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    userMessage += '\n\n‚ö†Ô∏è TROUBLESHOOTING STEPS:\n\n';
                    userMessage += '1. CHECK YOUR API KEY:\n';
                    userMessage += '   - Go to console.anthropic.com\n';
                    userMessage += '   - Make sure you have billing set up\n';
                    userMessage += '   - Verify your API key is active\n\n';
                    userMessage += '2. OPEN BROWSER CONSOLE (F12):\n';
                    userMessage += '   - Look for detailed error messages\n';
                    userMessage += '   - Check which proxy failed\n\n';
                    userMessage += '3. TRY AGAIN:\n';
                    userMessage += '   - Sometimes proxies are temporarily down\n';
                    userMessage += '   - Wait 30 seconds and retry\n\n';
                    userMessage += '4. ALTERNATIVE:\n';
                    userMessage += '   - Download the HTML file\n';
                    userMessage += '   - Open it locally (file:///)\n';
                    userMessage += '   - This bypasses some CORS issues';
                } else if (error.message.includes('credits')) {
                    userMessage += '\n\nüí≥ Please visit console.anthropic.com to add credits to your account.';
                } else if (error.message.includes('Authentication')) {
                    userMessage += '\n\nüîë Your API key appears to be invalid. Please:\n';
                    userMessage += '1. Go to console.anthropic.com\n';
                    userMessage += '2. Generate a new API key\n';
                    userMessage += '3. Copy it carefully (starts with sk-ant-)';
                }
                
                alert(userMessage);
                console.error('Full error:', error);
                console.error('Error stack:', error.stack);
            }
        }

        function backToSetup() {
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('submissionScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function backToSubmissions() {
            document.getElementById('submissionScreen').classList.remove('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        // PDF Export Function
        async function revealFinalRankings() {
            // Hide the button
            event.target.parentElement.remove();
            
            await getFinalRankings(window.judgmentResults);
        }

        async function getFinalRankings(results) {
            try {
                // Show loading indicator for rankings
                const rankingsPlaceholder = document.createElement('div');
                rankingsPlaceholder.id = 'rankingsLoading';
                rankingsPlaceholder.className = 'glass-effect rounded-2xl p-8 text-center mt-8';
                rankingsPlaceholder.innerHTML = `
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400 mb-4"></div>
                    <p class="text-gray-300">The judges are scoring all dishes...</p>
                `;
                document.getElementById('allJudgments').appendChild(rankingsPlaceholder);

                const apiKey = document.getElementById('apiKey').value.trim();

                // Request scores from judges for all dishes
                const dishesSummary = results.map(r => 
                    `**${r.contestantName}**: "${r.dishName}"`
                ).join('\n');

                const scoringPrompt = {
                    type: "text",
                    text: `You are the judging panel from Culinary Class Wars (ÌùëÎ∞±ÏöîÎ¶¨ÏÇ¨). You have provided detailed feedback on all dishes. Now you must assign numerical scores.

Here are all the dishes:

${dishesSummary}

For EACH dish above, provide scores from both judges in this EXACT format:
[Contestant Name]
Paik Jong Won: X.X/10
Anh Sung Jae: X.X/10

SCORING GUIDELINES:
**Paik Jong Won:**
- MORE LENIENT and encouraging
- Scores: 6.5-9.5/10 range, can go 5.5-10.0 for exceptional cases
- Use whole numbers (6.0, 7.0, 8.0) or half points (6.5, 7.5, 8.5)
- Show variance - not all dishes get the same score

**Anh Sung Jae:**
- MORE CRITICAL with higher standards
- Scores: 4.5-7.5/10 range, gives 8.0+ only for truly exceptional work
- Use whole numbers (5.0, 6.0, 7.0) or half points (5.5, 6.5, 7.5)  
- Show variance - differentiate between dishes clearly

${results.some(r => r.isMichelle) ? 'NOTE: Be slightly more lenient (add 0.5-1 point) for the birthday contestant. Maximum score is 10.0/10 - do not exceed this.' : ''}

IMPORTANT: Provide ONLY the scores in the format above, no additional commentary.`
                };

                const response = await fetch('/api/judge', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1500,
                        messages: [{ role: "user", content: [scoringPrompt] }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get scores');
                }

                const data = await response.json();
                const scoringText = data.content.find(c => c.type === 'text')?.text || '';

                // Parse scores from the response
                const dishesWithScores = results.map(result => {
                    // Find scores for this contestant in the scoring response
                    const contestantBlock = scoringText.split('\n\n').find(block => 
                        block.includes(result.contestantName)
                    );
                    
                    let paikScore = 0;
                    let anhScore = 0;
                    
                    if (contestantBlock) {
                        const paikMatch = contestantBlock.match(/Paik Jong Won:\s*(\d+(?:\.\d+)?)/i);
                        const anhMatch = contestantBlock.match(/Anh Sung Jae:\s*(\d+(?:\.\d+)?)/i);
                        
                        paikScore = paikMatch ? parseFloat(paikMatch[1]) : 0;
                        anhScore = anhMatch ? parseFloat(anhMatch[1]) : 0;
                    }
                    
                    const averageScore = (paikScore + anhScore) / 2;
                    
                    return {
                        contestantName: result.contestantName,
                        dishName: result.dishName,
                        paikScore,
                        anhScore,
                        averageScore
                    };
                });

                // Sort by average score (descending)
                dishesWithScores.sort((a, b) => b.averageScore - a.averageScore);

                // Get top 3 and runners-up
                const top3 = dishesWithScores.slice(0, 3);
                const runnersUp = dishesWithScores.slice(3);

                // Check if there are ties that need deliberation
                const needsDeliberation = (
                    top3.length >= 2 && Math.abs(top3[0].averageScore - top3[1].averageScore) < 0.01
                ) || (
                    top3.length >= 3 && Math.abs(top3[1].averageScore - top3[2].averageScore) < 0.01
                );

                let deliberationText = '';

                if (needsDeliberation) {
                    // Call API for deliberation on ties
                    rankingsPlaceholder.querySelector('p').textContent = 'The judges are deliberating on tied dishes...';
                    
                    const apiKey = document.getElementById('apiKey').value.trim();

                    const tiedDishes = top3.map(d => 
                        `**${d.contestantName}** ("${d.dishName}"): Paik ${d.paikScore}/10, Anh ${d.anhScore}/10, Average ${d.averageScore.toFixed(1)}/10`
                    ).join('\n');

                    const deliberationPrompt = {
                        type: "text",
                        text: `You are the judging panel from Culinary Class Wars (ÌùëÎ∞±ÏöîÎ¶¨ÏÇ¨). The top 3 dishes have been determined by scores, but some have TIED scores. You need to discuss the tiebreakers.

Here are the top 3 dishes with their scores:

${tiedDishes}

Have a brief back-and-forth discussion (3-4 lines) between Paik Jong Won and Anh Sung Jae about breaking the ties. Consider factors beyond the numerical scores:
- Creativity and innovation
- Technical difficulty
- Ingredient utilization
- Overall impression

Keep it under 100 words. Show their different perspectives but reach consensus on the final order.`
                    };

                    const response = await fetch('/api/judge', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 800,
                            messages: [{ role: "user", content: [deliberationPrompt] }]
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        deliberationText = data.content.find(c => c.type === 'text')?.text || '';
                    }
                }

                // Remove loading indicator
                document.getElementById('rankingsLoading').remove();

                // Play applause sound
                const applauseSound = document.getElementById('applauseSound');
                applauseSound.volume = 0.4;
                applauseSound.play().catch(e => console.log('Audio play failed:', e));

                // Build rankings display
                let rankingsHTML = `
                    <div class="text-center mb-6">
                        <h2 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-500 mb-2">
                            üèÜ FINAL RANKINGS üèÜ
                        </h2>
                        <p class="text-gray-300 text-lg">Based on judges' scores</p>
                    </div>
                `;

                // Add deliberation if there was one
                if (deliberationText) {
                    rankingsHTML += `
                        <div class="bg-gray-900/50 rounded-xl p-6 mb-6 border border-yellow-600/30">
                            <h3 class="text-yellow-400 font-bold text-lg mb-3">Judges' Deliberation on Tied Scores:</h3>
                            <div class="prose prose-invert max-w-none text-sm">
                                ${deliberationText.split('\n').map(line => 
                                    line.trim() ? `<p class="mb-2">${line}</p>` : ''
                                ).join('')}
                            </div>
                        </div>
                    `;
                }

                // Add rankings
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const colors = ['text-yellow-400', 'text-gray-300', 'text-orange-400'];
                const positions = ['1st Place', '2nd Place', '3rd Place'];

                rankingsHTML += '<div class="space-y-4">';
                top3.forEach((dish, idx) => {
                    rankingsHTML += `
                        <div class="bg-gray-800 rounded-xl p-6 border-2 ${idx === 0 ? 'border-yellow-500' : 'border-gray-700'}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="${colors[idx]} font-black text-2xl mb-2">
                                        ${medals[idx]} ${positions[idx]}
                                    </p>
                                    <p class="text-white font-bold text-xl mb-1">${dish.contestantName}</p>
                                    <p class="text-gray-400 italic mb-3">"${dish.dishName}"</p>
                                    <div class="flex gap-4 text-sm">
                                        <span class="text-red-400">Paik: ${dish.paikScore}/10</span>
                                        <span class="text-blue-400">Anh: ${dish.anhScore}/10</span>
                                        <span class="text-yellow-400 font-bold">Average: ${dish.averageScore.toFixed(1)}/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                rankingsHTML += '</div>';

                // Add runners-up section if there are any
                if (runnersUp.length > 0) {
                    rankingsHTML += `
                        <div class="mt-8 pt-8 border-t border-gray-700">
                            <h3 class="text-2xl font-bold text-gray-400 mb-6 text-center">Runners-Up</h3>
                            <div class="space-y-3">
                    `;
                    
                    runnersUp.forEach((dish, idx) => {
                        rankingsHTML += `
                            <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <p class="text-gray-400 font-bold text-lg mb-1">${dish.contestantName}</p>
                                        <p class="text-gray-500 text-sm italic mb-2">"${dish.dishName}"</p>
                                        <div class="flex gap-3 text-xs">
                                            <span class="text-red-400">Paik: ${dish.paikScore}/10</span>
                                            <span class="text-blue-400">Anh: ${dish.anhScore}/10</span>
                                            <span class="text-yellow-400 font-bold">Avg: ${dish.averageScore.toFixed(1)}/10</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    rankingsHTML += `
                            </div>
                        </div>
                    `;
                }

                // Add final rankings section
                const rankingsSection = document.createElement('div');
                rankingsSection.className = 'glass-effect rounded-2xl p-8 mt-8 animate-fade-in border-4 border-yellow-500';
                rankingsSection.innerHTML = rankingsHTML;
                document.getElementById('allJudgments').appendChild(rankingsSection);

                // Store winner data globally for potential future use
                window.winnerData = {
                    name: top3[0].contestantName,
                    dishName: top3[0].dishName,
                    paikScore: top3[0].paikScore,
                    anhScore: top3[0].anhScore,
                    averageScore: top3[0].averageScore
                };

                // Scroll to rankings
                rankingsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                console.error('Error getting rankings:', error);
                // Remove loading indicator if it exists
                const loadingEl = document.getElementById('rankingsLoading');
                if (loadingEl) loadingEl.remove();
                
                // Show error message
                const errorSection = document.createElement('div');
                errorSection.className = 'glass-effect rounded-2xl p-8 mt-8 bg-red-900/20 border border-red-600';
                errorSection.innerHTML = `
                    <p class="text-red-400 text-center">
                        Could not generate final rankings. Please check the individual scores above.
                    </p>
                `;
                document.getElementById('allJudgments').appendChild(errorSection);
            }
        }
    </script>
</body>
</html>
